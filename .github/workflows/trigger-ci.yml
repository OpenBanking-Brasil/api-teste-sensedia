name: Trigger CI/CD Workflow (PR de Fork)

on:
  pull_request_target:
    types:
      - opened
      - synchronize
      - reopened
    branches:
      - main

jobs:
  trigger:
    runs-on: ubuntu-latest
    steps:
      - name: Construir a URL RAW do Swagger.yaml (Novo)
        id: get_raw_urls
        run: |
          SWAGGER_NEW_URL="https://raw.githubusercontent.com/${{ github.event.pull_request.head.repo.full_name }}/${{ github.event.pull_request.head.ref }}/swagger.yaml"
          SWAGGER_OLD_URL="https://raw.githubusercontent.com/${{ github.event.pull_request.base.repo.full_name }}/${{ github.event.pull_request.base.ref }}/swagger.yaml"

          echo "SWAGGER_NEW_URL=$SWAGGER_NEW_URL" >> $GITHUB_ENV
          echo "OLD_SWAGGER_FILE_URL=$SWAGGER_OLD_URL" >> $GITHUB_ENV

      - name: Capturar Informa√ß√µes do PR
        run: |
          echo "PR_TITLE=${{ github.event.pull_request.title }}" >> $GITHUB_ENV
          echo "PR_URL=${{ github.event.pull_request.html_url }}" >> $GITHUB_ENV
          echo "PR_AUTHOR=${{ github.event.pull_request.user.login }}" >> $GITHUB_ENV

          # Adicionando suporte a multiline para PR_DESCRIPTION
          {
            echo 'PR_DESCRIPTION<<EOF'
            echo "${{ github.event.pull_request.body }}"
            echo 'EOF'
          } >> $GITHUB_ENV

      - name: Exibir Vari√°veis do PR (Debug)
        run: |
          echo "Swagger YAML (novo): ${{ env.SWAGGER_NEW_URL }}"
          echo "Swagger YAML (antigo): ${{ env.OLD_SWAGGER_FILE_URL }}"
          echo "T√≠tulo do PR: ${{ env.PR_TITLE }}"
          echo "Descri√ß√£o do PR: ${{ env.PR_DESCRIPTION }}"
          echo "URL do PR: ${{ env.PR_URL }}"
          echo "Autor do PR: ${{ env.PR_AUTHOR }}"

      - name: Acionar workflow no `repo-ci-cd`
        run: |
          PR_DESCRIPTION_CLEANED=$(echo "${{ env.PR_DESCRIPTION }}" | tr '\n' ' ' | tr -d '\r' | jq -Rs .)

          curl -X POST -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.REPO_ACCESS_TOKEN }}" \
            https://api.github.com/repos/OpenBanking-Brasil/CI-CD-OFB/actions/workflows/pr-validation-and-jira.yml/dispatches \
            -d "{
              \"ref\": \"main\",
              \"inputs\": {
                \"SWAGGER_FILE_URL\": \"${{ env.SWAGGER_NEW_URL }}\",
                \"OLD_SWAGGER_FILE_URL\": \"${{ env.OLD_SWAGGER_FILE_URL }}\",
                \"PR_TITLE\": \"${{ env.PR_TITLE }}\",
                \"PR_DESCRIPTION\": $PR_DESCRIPTION_CLEANED,
                \"PR_URL\": \"${{ env.PR_URL }}\",
                \"PR_AUTHOR\": \"${{ env.PR_AUTHOR }}\"
              }
            }"
      - name: Esperar execu√ß√£o do CI/CD
        run: |
          echo "‚è≥ Aguardando execu√ß√£o do workflow no CI/CD..."

          # Pega a execu√ß√£o mais recente do workflow para o branch main
          for i in {1..60}; do
            RUN_ID=$(curl -s -H "Authorization: token ${{ secrets.REPO_ACCESS_TOKEN }}" \
              "https://api.github.com/repos/OpenBanking-Brasil/CI-CD-OFB/actions/runs?branch=main&event=workflow_dispatch" \
              | jq -r '.workflow_runs[] | select(.name == "Validate PR and Create Jira Task") | .id' | head -n 1)

            if [[ "$RUN_ID" != "" ]]; then
              echo "üÜî Encontrado RUN_ID: $RUN_ID"
              break
            fi
            sleep 5
          done

          if [[ "$RUN_ID" == "" ]]; then
            echo "‚ùå N√£o foi poss√≠vel encontrar a execu√ß√£o do workflow."
            exit 1
          fi

          # Agora aguarda a finaliza√ß√£o do workflow
          for i in {1..100}; do
            STATUS=$(curl -s -H "Authorization: token ${{ secrets.REPO_ACCESS_TOKEN }}" \
              "https://api.github.com/repos/OpenBanking-Brasil/CI-CD-OFB/actions/runs/$RUN_ID" \
              | jq -r '.status')

            CONCLUSION=$(curl -s -H "Authorization: token ${{ secrets.REPO_ACCESS_TOKEN }}" \
              "https://api.github.com/repos/OpenBanking-Brasil/CI-CD-OFB/actions/runs/$RUN_ID" \
              | jq -r '.conclusion')

            echo "‚è±Ô∏è Status: $STATUS | Conclus√£o: $CONCLUSION"

            if [[ "$STATUS" == "completed" ]]; then
              if [[ "$CONCLUSION" != "success" ]]; then
                echo "‚ùå Workflow do CI/CD falhou!"
                exit 1
              fi
              echo "‚úÖ Workflow do CI/CD finalizado com sucesso."
              break
            fi
            sleep 10
          done

